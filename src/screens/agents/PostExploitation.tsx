import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react'
import { createColumns, TableTypes, CenteredCard, Form, createFields } from 'material-crud'
import { useNavigator } from 'material-navigator'
import { useSnackbar } from 'notistack'
import CustomTable from '../../components/Table/CustomTable'
import { useSocket } from '../../util/SocketContext'
import { Collapse, Typography } from '@material-ui/core'
import { renderType } from '../../components/FullCrud'
import * as Yup from 'yup'

interface Description {
  default_value: string
  description: string
  example: string
  name: string
  required: boolean
  type: string
}

interface DataProps {
  name: string
  description: string
  id_module: number
  options_description: Description[]
}

const PostExploitation = () => {
  const listRef = useRef(false)
  const { send, onError, onMessage } = useSocket()
  const { setLoading } = useNavigator()
  const { enqueueSnackbar } = useSnackbar()

  const [rowSelected, setRowSelected] = useState<DataProps | undefined>(undefined)
  const [data, setData] = useState<DataProps[]>([])
  const columns = useMemo(
    () =>
      createColumns([
        { id: 'id_module', title: 'ID', type: TableTypes.String, width: 2 },
        { id: 'name', title: 'Name', type: TableTypes.String, width: 3 },
        { id: 'description', title: 'Description', type: TableTypes.String, width: 4 },
      ]),
    [],
  )
  const fields = useMemo(() => {
    if (!rowSelected || !rowSelected.options_description.length) return []
    else {
      const maped = rowSelected.options_description.map(
        ({ default_value, description, example, name, required, type }) => ({
          id: name,
          title: name,
          type: renderType(type),
          help: description ? (
            <React.Fragment>
              <Typography color="inherit">{description}</Typography>
              {example && <em>Example: {example}</em>}
            </React.Fragment>
          ) : (
            ''
          ),
          validate: required ? Yup.string().required('Required') : undefined,
          defaultValue: default_value,
        }),
      )
      const finalArray: any[] = []
      maped.forEach((item, index) => {
        let toAdd = null
        if ((index + 1) % 2 === 0) toAdd = [maped[index - 1], item]
        else if (index === maped.length - 1) toAdd = [item]
        if (toAdd) finalArray.push(toAdd)
      })
      return createFields(finalArray)
    }
  }, [rowSelected])

  const handleSocket = useCallback(
    (
      typeAction: 'list' | 'execute',
      data?: { id_module: number; options: { target: string; ports: string } },
    ) => {
      onMessage(async (e) => {
        const { type, reference, content, content_url } = JSON.parse(e.data || '{}')
        if (type === 'task.created') {
          setLoading(true, 'bottomRight')
          switch (typeAction) {
            case 'list':
              send({ type: 'post_exploitation.available', reference })
              break
            case 'execute':
              send({ type: 'post_exploitation.execute', reference, ...data })
              break
            default:
              break
          }
        } else if (content) {
          setLoading(false)
          switch (type) {
            case 'post_exploitation.available.result':
              setData(content)
              break
            case 'post_exploitation.execute.result.ok':
              if (content_url) {
                // const { response } = await callWs<Blob>({
                //   url: Urls.tasks_download,
                //   responseType: 'blob',
                //   params: { 'task-reference': reference },
                //   headers,
                // })
                // if (response) {
                //   const url = window.URL.createObjectURL(new Blob([response]))
                //   const link = document.createElement('a')
                //   link.href = url
                //   link.setAttribute('download', 'download')
                //   document.body.appendChild(link)
                //   link.click()
                //   link.remove()
                // }
              } else {
                enqueueSnackbar(content, { variant: 'success' })
              }
              break
            case 'post_exploitation.execute.result.error':
              enqueueSnackbar(content, { variant: 'error' })
              break
            default:
              break
          }
        }
      })
      onError((e) => {
        setLoading(false)
        enqueueSnackbar('Error ocurred')
      })
      send({ type: 'create.task' })
    },
    [send, onMessage, onError, enqueueSnackbar, setLoading],
  )

  useEffect(() => {
    if (!listRef.current) {
      handleSocket('list')
      listRef.current = true
    }
  }, [handleSocket])

  return (
    <React.Fragment>
      <Collapse in={rowSelected === undefined}>
        <CustomTable
          data={data}
          columns={columns}
          onClickRow={({ rowData }) => {
            const typed: DataProps = rowData
            if (!typed.options_description || !typed.options_description.length) {
              enqueueSnackbar('Without options', { variant: 'error' })
              return false
            }
            setRowSelected(rowData)
          }}
        />
      </Collapse>
      <Collapse in={rowSelected !== undefined}>
        <CenteredCard
          title={rowSelected?.name}
          subtitle="Please complete options to execute"
          onClose={() => setRowSelected(undefined)}>
          <Form
            showHelpIcon
            accept="Execute"
            fields={fields}
            onSubmit={(values) => {
              handleSocket('execute', {
                id_module: rowSelected?.id_module!!,
                options: { ports: values.ports, target: values.target },
              })
            }}
          />
        </CenteredCard>
      </Collapse>
    </React.Fragment>
  )
}

export default PostExploitation
